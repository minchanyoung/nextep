NEXTEP.AI í”„ë¡œì íŠ¸ ë³´ê³ ì„œ - ì£¼ìš” ì„œë¹„ìŠ¤ ê¸°ëŠ¥ ë° ì†ŒìŠ¤ ì½”ë“œ ì •ë¦¬
================================================================

ğŸ¤– 1. ë¨¸ì‹ ëŸ¬ë‹ í•­ëª©
================================================================

1-1. ë¨¸ì‹ ëŸ¬ë‹ í”¼ì²˜ ì—”ì§€ë‹ˆì–´ë§ ë° ì‹œë‚˜ë¦¬ì˜¤ ìƒì„±
íŒŒì¼: app/ml/preprocessing.py (19ì¤„~48ì¤„)
-----------------------------------------------------------------
def prepare_income_model_features(user_input, ml_predictor):
    """
    ì†Œë“ ëª¨ë¸ì„ ìœ„í•œ ì •í™•í•œ í”¼ì²˜ ìƒì„±
    """
    from flask import current_app
    
    # ê¸°ë³¸ ì‹œë‚˜ë¦¬ì˜¤ 3ê°œ(í˜„ì§, ì§ì—…A, ì§ì—…B) ìƒì„±
    scenarios = []
    job_categories = [
        user_input["current_job_category"],
        user_input["job_A_category"], 
        user_input["job_B_category"]
    ]

    for i, job_cat_code in enumerate(job_categories):
        scenario = {
            "age": int(user_input["age"]),
            "gender": int(user_input["gender"]),
            "education": int(user_input["education"]),
            "monthly_income": int(user_input["monthly_income"]),
            "job_satisfaction": int(user_input["job_satisfaction"]),
            "job_category": int(job_cat_code)
        }
        scenarios.append(scenario)

    df = pd.DataFrame(scenarios)

    # prev_job_satisfaction ì¶”ê°€
    df['prev_job_satisfaction'] = df['job_satisfaction']


1-2. LightGBM ì†Œë“ ì˜ˆì¸¡ ëª¨ë¸ 
íŒŒì¼: app/ml/routes.py (174ì¤„~207ì¤„)
-----------------------------------------------------------------
            income_model_features = [income_row.get(f, 0.0) for f in income_features]
            income_input = np.array(income_model_features).reshape(1, -1)
            base_income_change = float(lgb_income_model.predict(income_input)[0])
            
            # ì§ì—…ë³„ ì†Œë“ ë³€í™”ìœ¨ ë³´ì • (ê°•ë ¥í•œ ì°¨ë³„í™”)
            current_job = int(user_input["current_job_category"])
            target_job = income_row.get('job_category', current_job)
            
            if target_job != current_job:  # ì´ì§ ì‹œë‚˜ë¦¬ì˜¤
                # ì§ì—…ë³„ ê¸°ë³¸ ì†Œë“ í”„ë¦¬ë¯¸ì—„/ë””ìŠ¤ì¹´ìš´íŠ¸ ì ìš©
                job_income_multiplier = {
                    1: 1.20,  # ê´€ë¦¬ì - 20% ì†Œë“ í”„ë¦¬ë¯¸ì—„
                    2: 1.35,  # ì „ë¬¸ê°€ - 35% ì†Œë“ í”„ë¦¬ë¯¸ì—„ (ìµœê³ )
                    3: 1.05,  # ì‚¬ë¬´ì§ - 5% ì†Œë“ í”„ë¦¬ë¯¸ì—„ (ì•ˆì •ì )
                    4: 0.90,  # ì„œë¹„ìŠ¤ì§ - 10% ì†Œë“ ê°ì†Œ ìœ„í—˜
                    5: 1.15   # íŒë§¤ì§ - 15% ì†Œë“ ë³€ë™ì„± (ì„±ê³¼ ê¸°ë°˜)
                }.get(target_job, 1.0)
                
                # í˜„ì¬ ì§ì—…ì—ì„œì˜ ì´ì§ ë‚œì´ë„ ë³´ì •
                job_transition_difficulty = {
                    1: 0.15,  # ê´€ë¦¬ìë¡œ ì´ì§ - ì–´ë ¤ì›€ (ì†Œë“ ì¦ê°€ ì œí•œ)
                    2: 0.25,  # ì „ë¬¸ê°€ë¡œ ì´ì§ - ë§¤ìš° ì–´ë ¤ì›€ (í° ì†Œë“ ì¦ê°€ ê°€ëŠ¥)
                    3: 0.05,  # ì‚¬ë¬´ì§ìœ¼ë¡œ ì´ì§ - ì‰¬ì›€ (ì†Œë“ ë³€í™” ì ìŒ)
                    4: -0.10, # ì„œë¹„ìŠ¤ì§ìœ¼ë¡œ ì´ì§ - ì†Œë“ ê°ì†Œ ìœ„í—˜
                    5: 0.10   # íŒë§¤ì§ìœ¼ë¡œ ì´ì§ - ë³€ë™ì„± í¼
                }.get(target_job, 0.0)
                
                income_change = base_income_change * job_income_multiplier + job_transition_difficulty
            else:
                # í˜„ì§ ìœ ì§€ - ê¸°ë³¸ ì˜ˆì¸¡ê°’ ì‚¬ìš© (ì†Œí­ ë³´ì •)
                income_change = base_income_change * 1.02  # 2% ì•ˆì •ì„± ë³´ë„ˆìŠ¤
            
            # í˜„ì‹¤ì  ë²”ìœ„ë¡œ ì œí•œ
            income_change = max(-0.50, min(1.00, income_change))


1-3. ì•™ìƒë¸” ë§Œì¡±ë„ ì˜ˆì¸¡ ì‹œìŠ¤í…œ (XGBoost + LightGBM + CatBoost)
íŒŒì¼: app/ml/routes.py (216ì¤„~243ì¤„)
-----------------------------------------------------------------
            predictions = []
            for name, model in ensemble_models.items():
                if model:
                    try:
                        if name == 'cat':
                            # CatBoostìš© ë°ì´í„°í”„ë ˆì„ ìƒì„± (ì¹´í…Œê³ ë¦¬í˜• í”¼ì²˜ íƒ€ì… ë³´ì •)
                            cat_df = pd.DataFrame([satis_model_features], columns=satis_features)
                            
                            # ì¹´í…Œê³ ë¦¬í˜• í”¼ì²˜ë“¤ì„ ì •ìˆ˜ë¡œ ë³€í™˜ (CatBoost ìš”êµ¬ì‚¬í•­)
                            categorical_features = ['age', 'gender', 'education', 'job_category', 'career_stage']
                            for cat_col in categorical_features:
                                if cat_col in cat_df.columns:
                                    cat_df[cat_col] = cat_df[cat_col].astype(int)
                            
                            pred = float(model.predict(cat_df)[0])
                        else:
                            pred = float(model.predict(satis_input)[0])
                        predictions.append((pred, weights.get(name, 0.33)))
                    except Exception as e:
                        logger.warning(f"{name} ë§Œì¡±ë„ ëª¨ë¸ ì˜ˆì¸¡ ì‹¤íŒ¨: {e}")
            
            if predictions:
                weighted_sum = sum(pred * w for pred, w in predictions)
                total_weight = sum(w for _, w in predictions)
                satis_change = weighted_sum / total_weight if total_weight > 0 else 0.0
            else:
                satis_change = 0.0 # ëª¨ë“  ë§Œì¡±ë„ ëª¨ë¸ ì‹¤íŒ¨ ì‹œ


================================================================
ğŸŒ 2. Flask í•­ëª© 
================================================================

2-1. ë™ì  ì˜ˆì¸¡ API ë¼ìš°íŠ¸ (AJAX ì§€ì›)
íŒŒì¼: app/main/routes.py (88ì¤„~118ì¤„)
-----------------------------------------------------------------
    if request.method == 'POST':
        # POST ìš”ì²­ ì‹œ í•­ìƒ ìƒˆë¡œìš´ ì˜ˆì¸¡ ì‹¤í–‰ (AJAX í¬í•¨)
        user_input = _create_user_input(request.form)
        
        # ë””ë²„ê¹…: í¼ ë°ì´í„°ì™€ ìµœì¢… user_input ë¡œê¹…
        current_app.logger.info(f"{'AJAX ' if is_ajax else ''}í¼ ë°ì´í„° - ì§ì—…êµ°A: {request.form.get('job_A_category')}, ì§ì—…êµ°B: {request.form.get('job_B_category')}")
        current_app.logger.info(f"{'AJAX ' if is_ajax else ''}ìµœì¢… user_input: {user_input}")
        current_app.logger.info(f"{'AJAX ' if is_ajax else ''}ì˜ˆì¸¡ ì‹œì‘: í˜„ì§={user_input['current_job_category']}, A={user_input['job_A_category']}, B={user_input['job_B_category']}")
        try:
            prediction_results = services.run_prediction(user_input)
            current_app.logger.info(f"ì˜ˆì¸¡ ì™„ë£Œ - ê²°ê³¼ ê°œìˆ˜: {len(prediction_results)}")
            
            # ì˜ˆì¸¡ ê²°ê³¼ ë¡œê¹… (ë””ë²„ê¹…ìš©)
            for i, result in enumerate(prediction_results):
                current_app.logger.info(f"  ì‹œë‚˜ë¦¬ì˜¤ {i}: ì†Œë“ë³€í™”={result.get('income_change_rate', 'N/A')}, "
                                       f"ë§Œì¡±ë„ë³€í™”={result.get('satisfaction_change_score', 'N/A')}")
            
            if not is_guest:  # íšŒì›ì˜ ê²½ìš° í•­ìƒ ì„¸ì…˜ ì €ì¥ (AJAX í¬í•¨)
                set_prediction_data(user_input, prediction_results)
                current_app.logger.info(f"ì„¸ì…˜ ë°ì´í„° ì—…ë°ì´íŠ¸: ì§ì—…êµ°A={user_input['job_A_category']}, ì§ì—…êµ°B={user_input['job_B_category']}")
        except Exception as e:
            current_app.logger.error(f"ì˜ˆì¸¡ ì¤‘ ì˜¤ë¥˜: {e}", exc_info=True)
            prediction_results = DEFAULT_PREDICTION_RESULTS
            error_message = "ì˜ˆì¸¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”."

    if is_ajax:
        return jsonify({
            'status': 'success',
            'prediction_results': prediction_results,
            'user_input': user_input,
            'job_category_map': JOB_CATEGORY_MAP
        })


2-2. ë“œë¡­ë‹¤ìš´ ê°’ ì¶”ì¶œ ë° ì‚¬ìš©ì ì…ë ¥ ìƒì„±
íŒŒì¼: app/main/routes.py (35ì¤„~51ì¤„)
-----------------------------------------------------------------
    # ë“œë¡­ë‹¤ìš´ì—ì„œ ì„ íƒëœ ì§ì—…êµ° A, B ì‚¬ìš© (í¼ ë°ì´í„°ì—ì„œ ì§ì ‘)
    job_A = str(get_val('job_A_category', '2'))  # ê¸°ë³¸ê°’ ì „ë¬¸ê°€
    job_B = str(get_val('job_B_category', '4'))  # ê¸°ë³¸ê°’ ì„œë¹„ìŠ¤ì§
    
    # ë§Œì•½ í¼ì—ì„œ ê°’ì´ ì—†ìœ¼ë©´ ê¸°ì¡´ ë¡œì§ ì‚¬ìš© (ì´ˆê¸° ë¡œë“œ ì‹œ)
    if not is_form or not get_val('job_A_category'):
        job_A, job_B = _get_alternative_jobs(current_job)

    user_input = {
        'age': str(get_val('age')),
        'gender': str(get_val('gender')),
        'education': str(get_val('education')),
        'monthly_income': str(get_val('monthly_income')),
        'current_job_category': current_job,
        'job_satisfaction': str(get_val('job_satisfaction')),
        'job_A_category': job_A,
        'job_B_category': job_B,
    }


2-3. ì„¸ì…˜ ê¸°ë°˜ ì‚¬ìš©ì ë°ì´í„° ê´€ë¦¬ 
íŒŒì¼: app/utils/web_helpers.py (66ì¤„~83ì¤„)
-----------------------------------------------------------------
def get_prediction_data() -> Optional[Dict]:
    """ì˜ˆì¸¡ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°"""
    return session.get('prediction_data')

def set_prediction_data(user_input: Dict, prediction_results: list) -> None:
    """ì˜ˆì¸¡ ë°ì´í„° ì„¤ì •"""
    session['prediction_data'] = {
        'user_input': user_input,
        'prediction_results': prediction_results
    }

def get_chat_messages() -> list:
    """ì±„íŒ… ë©”ì‹œì§€ ê°€ì ¸ì˜¤ê¸°"""
    return session.get('chat_messages', [])

def set_chat_messages(messages: list) -> None:
    """ì±„íŒ… ë©”ì‹œì§€ ì„¤ì •"""
    session['chat_messages'] = messages


================================================================
ğŸ§  3. LLM ë° RAG í•­ëª©
================================================================

3-1. RAG ê¸°ë°˜ ì»¤ë¦¬ì–´ ì¡°ì–¸ ìƒì„±
íŒŒì¼: app/services.py (234ì¤„~270ì¤„)
-----------------------------------------------------------------
def generate_career_advice_hf(user_input, prediction_results, job_category_map, satis_factor_map):
    """LangChain ê¸°ë°˜ ì»¤ë¦¬ì–´ ì¡°ì–¸ ìƒì„± (PDF ë°ì´í„° í†µí•© RAG)"""
    try:
        llm_service = get_llm_service()
        rag_manager = get_rag_manager()
        
        if not llm_service:
            raise LLMServiceError("LLM ì„œë¹„ìŠ¤ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
        
        # RAG ê²€ìƒ‰ì„ ìœ„í•œ í†µí•© ì¿¼ë¦¬ ìƒì„±
        current_job_name = job_category_map.get(user_input.get('current_job_category', ''), 'ì•Œ ìˆ˜ ì—†ìŒ')
        job_a_name = job_category_map.get(user_input.get('job_A_category', ''), 'ì•Œ ìˆ˜ ì—†ìŒ')
        job_b_name = job_category_map.get(user_input.get('job_B_category', ''), 'ì•Œ ìˆ˜ ì—†ìŒ')
        
        search_query = f"""
        {current_job_name} ì§ì—…ì—ì„œ {job_a_name} {job_b_name} ì´ì§ ìƒë‹´ ì»¤ë¦¬ì–´ ì¡°ì–¸ ì§ì—…ë§Œì¡±ë„ ê°œì„ ë°©ì•ˆ
        ì—°ë ¹: {user_input.get('age', '?')}ì„¸
        ì›”ì†Œë“: {user_input.get('monthly_income', '?')}ë§Œì›
        ì§ì—…ë§Œì¡±ë„: {user_input.get('job_satisfaction', '?')}/5ì 
        """
        
        # RAGë¥¼ í†µí•œ ê´€ë ¨ ë¬¸ì„œ ê²€ìƒ‰
        relevant_docs = ""
        if rag_manager:
            try:
                relevant_docs = rag_manager.search_documents(search_query, top_k=5)
            except Exception as e:
                logger.warning(f"RAG ê²€ìƒ‰ ì‹¤íŒ¨: {e}")

        # ì‚¬ìš©ì ë§Œì¡±ë„ ìš”ì¸ ë¶„ì„
        satis_factors = []
        for key in ['satis_wage', 'satis_stability', 'satis_growth', 'satis_task_content', 
                   'satis_work_env', 'satis_work_time', 'satis_communication', 'satis_fair_eval', 'satis_welfare']:
            value = user_input.get(key, 3)
            factor_name = satis_factor_map.get(key, key)
            satis_factors.append(f"{factor_name}: {value}/5ì ")


3-2. ìŠ¤íŠ¸ë¦¬ë° ëŒ€í™”í˜• ì¡°ì–¸ ì‹œìŠ¤í…œ
íŒŒì¼: app/services.py (332ì¤„~390ì¤„)
-----------------------------------------------------------------
def generate_follow_up_advice_stream(user_message: str, chat_history: List[Dict], context_summary: str = "") -> Iterator[str]:
    """LangChain ê¸°ë°˜ ìŠ¤íŠ¸ë¦¬ë° ì¶”ê°€ ì§ˆë¬¸ ì‘ë‹µ"""
    try:
        llm_service = get_llm_service()
        rag_manager = get_rag_manager()
        
        if not llm_service:
            raise LLMServiceError("LLM ì„œë¹„ìŠ¤ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
            
        # ëŒ€í™” ê¸°ë¡ì„ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜ (ìµœê·¼ 5ê°œë§Œ)
        history_text = ""
        if chat_history:
            recent_messages = chat_history[-5:]
            history_text = "\n".join([
                f"{msg.get('role', 'ì‚¬ìš©ì')}: {msg.get('content', '')}" 
                for msg in recent_messages 
                if msg.get('content')
            ])
        
        # RAG ê²€ìƒ‰ìœ¼ë¡œ ì¶”ê°€ ì»¨í…ìŠ¤íŠ¸ íšë“
        additional_context = ""
        if rag_manager:
            try:
                additional_context = rag_manager.search_documents(user_message, top_k=3)
            except Exception as e:
                logger.warning(f"RAG ê²€ìƒ‰ ì‹¤íŒ¨: {e}")
        
        # ìŠ¤íŠ¸ë¦¬ë° ì‘ë‹µì„ ìœ„í•œ í”„ë¡¬í”„íŠ¸ êµ¬ì„±
        stream_response = llm_service.generate_streaming_response({
            "context_summary": context_summary or "ì´ì „ ì»¤ë¦¬ì–´ ë¶„ì„ ê²°ê³¼ ì—†ìŒ",
            "chat_history": history_text or "ì´ì „ ëŒ€í™” ê¸°ë¡ ì—†ìŒ",
            "additional_context": additional_context or "ì¶”ê°€ ì°¸ê³  ì •ë³´ ì—†ìŒ",
            "user_question": user_message
        })
        
        # ìŠ¤íŠ¸ë¦¬ë° í…ìŠ¤íŠ¸ë¥¼ ì²­í¬ ë‹¨ìœ„ë¡œ ë°˜í™˜
        for chunk in stream_response:
            if chunk and chunk.strip():
                yield chunk
                
    except Exception as e:
        logger.error(f"ìŠ¤íŠ¸ë¦¬ë° ì¡°ì–¸ ìƒì„± ì‹¤íŒ¨: {e}")
        yield "ìŠ¤íŠ¸ë¦¬ë° ì‘ë‹µ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."


3-3. ì»¨í…ìŠ¤íŠ¸ ìš”ì•½ ë° ì±„íŒ… ì„¸ì…˜ ê´€ë¦¬
íŒŒì¼: app/services.py (398ì¤„~410ì¤„)
-----------------------------------------------------------------
def summarize_context_hf(user_input: Dict, prediction_results: List, job_category_map: Dict, satis_factor_map: Dict) -> str:
    """ì»¨í…ìŠ¤íŠ¸ ìš”ì•½ (ëŒ€í™” ì„¸ì…˜ìš©)"""
    try:
        current_job = job_category_map.get(user_input.get('current_job_category', ''), 'ì•Œ ìˆ˜ ì—†ìŒ')
        focus_key = satis_factor_map.get(user_input.get('satis_focus_key'), 'ì§€ì •ë˜ì§€ ì•ŠìŒ')
        
        summary = f"""ì‚¬ìš©ì ì •ë³´: {user_input.get('age', '?')}ì„¸, {current_job}, ì›”ì†Œë“ {user_input.get('monthly_income', '?')}ë§Œì›
ì¤‘ìš” ê°€ì¹˜: {focus_key}
AI ì˜ˆì¸¡ì„ ë°”íƒ•ìœ¼ë¡œ ì»¤ë¦¬ì–´ ì¡°ì–¸ì„ ì œê³µí–ˆìŠµë‹ˆë‹¤."""
        
        return summary
    except Exception as e:
        logger.error(f"ì»¨í…ìŠ¤íŠ¸ ìš”ì•½ ì‹¤íŒ¨: {e}")
        return "ì»¨í…ìŠ¤íŠ¸ ìš”ì•½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."


================================================================
ğŸ“Š ê¸°ìˆ  ìŠ¤íƒ ìš”ì•½
================================================================

ë¨¸ì‹ ëŸ¬ë‹:
- LightGBM (ì†Œë“ ì˜ˆì¸¡)
- XGBoost, LightGBM, CatBoost (ë§Œì¡±ë„ ì•™ìƒë¸” ì˜ˆì¸¡)
- í•œêµ­ë…¸ë™íŒ¨ë„(KLIPS) 117,397ê±´ ë°ì´í„° í•™ìŠµ

Flask:
- ë™ì  AJAX API
- ì„¸ì…˜ ê¸°ë°˜ ìƒíƒœ ê´€ë¦¬
- ì‹¤ì‹œê°„ ë“œë¡­ë‹¤ìš´ ì—°ë™

LLM & RAG:
- Ollama LLM (ë¡œì»¬ ì‹¤í–‰)
- LangChain í”„ë ˆì„ì›Œí¬
- PDF ë¬¸ì„œ ê¸°ë°˜ RAG ê²€ìƒ‰
- ìŠ¤íŠ¸ë¦¬ë° ëŒ€í™”í˜• ì‘ë‹µ