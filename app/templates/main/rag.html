{% extends 'base.html' %}

{% block title %}RAG | NEXTEP.AI{% endblock %}

{% block head %}
    {{ super() }}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/header.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/footer.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/rag.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
{% endblock %}

{% block header %}
    {% include 'common/header.html' %}
{% endblock %}

{% block content %}
<div class="rag-hero">
    <div class="hero-background">
        <div class="hero-pattern"></div>
        <div class="floating-elements">
            <div class="floating-icon"><i class="fas fa-file-alt"></i></div>
            <div class="floating-icon"><i class="fas fa-lightbulb"></i></div>
            <div class="floating-icon"><i class="fas fa-link"></i></div>
            <div class="floating-icon"><i class="fas fa-check-circle"></i></div>
        </div>
    </div>
    <div class="hero-content">
        <h1><i class="fas fa-search-plus icon"></i><span>RAG</span></h1>
        <p>AI가 어떤 문서를 참고하여 답변을 생성하는지 직접 확인해보세요.</p>
    </div>
</div>

<div class="wrapper">
    <form method="POST" class="rag-form">
        <textarea name="query" placeholder="질문을 입력하세요.">{{ query or '' }}</textarea>
        <button type="submit">질문하기</button>
    </form>

    {% if answer %}
    <div class="results-container">
        <div class="result-section">
            <h2><i class="fas fa-brain icon"></i>생성 답변</h2>
            <div class="result-box answer-box" id="aiAnswer">
                {{ answer }}
            </div>
        </div>

        <div class="result-section">
            <h2><i class="fas fa-book-open icon"></i>참고한 문서</h2>
            <p class="source-description">아래 문서는 입력된 질문과 가장 관련성이 높다고 판단된 순서로 표시됩니다.</p>
            {% if sources %}
                {% for source_item in sources %}
                    <div class="source-card">
                        <div class="source-header">
                            <span class="source-number">{{ loop.index }}</span>
                            <p class="source-filename">
                                <i class="fas fa-file-pdf"></i>
                                <b>출처:</b> {{ source_item.source.split('\\')[-1].split('/')[-1] }}
                            </p>
                        </div>
                        <div class="source-content" data-source-content>
                            {{ source_item.content }}
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <div class="result-box source-box">
                    <p>참고한 문서를 찾지 못했습니다. AI가 자체 지식으로 답변했습니다.</p>
                </div>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block footer %}
    {% include 'common/footer.html' %}
{% endblock %}

{% block scripts %}
    {{ super() }}
    <!-- Marked.js for markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/lib/marked.umd.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // 마크다운을 HTML로 변환하는 함수 (advice.js와 동일)
            function parseMarkdown(text) {
                if (typeof marked === 'undefined') return text.replace(/\n/g, '<br>');

                // marked 설정
                marked.setOptions({
                    breaks: true,
                    gfm: true,
                    sanitize: false
                });

                return marked.parse(text);
            }

            // RAG 답변에 마크다운 적용
            const aiAnswer = document.getElementById('aiAnswer');
            if (aiAnswer) {
                const originalText = aiAnswer.textContent.trim();
                if (originalText) {
                    aiAnswer.innerHTML = parseMarkdown(originalText);
                }
            }

            // RAG 소스 내용에 마크다운 적용
            const sourceContents = document.querySelectorAll('[data-source-content]');
            sourceContents.forEach(content => {
                const originalText = content.textContent.trim();
                if (originalText) {
                    content.innerHTML = parseMarkdown(originalText);
                }
            });
        });
    </script>
{% endblock %}
