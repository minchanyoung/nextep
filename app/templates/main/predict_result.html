{% extends 'base.html' %}

{% block title %}예측 결과 | NEXTEP.AI{% endblock %}

{% block head %}
    {{ super() }}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/header.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/footer.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/predict_result.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
{% endblock %}

{% block header %}
    {% include 'common/header.html' %}
{% endblock %}

{% block content %}
<div class="page-wrapper">
    <aside class="sidebar">
        <h3>직업군 선택</h3>
        <form id="predictionForm" action="{{ url_for('main.predict_result') }}" method="post">
            {# 페이지에서 직접 변경되지 않는 원본 사용자 정보만 hidden으로 유지 #}
            <input type="hidden" name="age" value="{{ user_input.age }}">
            <input type="hidden" name="gender" value="{{ user_input.gender }}">
            <input type="hidden" name="education" value="{{ user_input.education }}">
            <input type="hidden" name="monthly_income" value="{{ user_input.monthly_income }}">
            <input type="hidden" name="job_satisfaction" value="{{ user_input.job_satisfaction }}">
            <input type="hidden" name="current_job_category" value="{{ user_input.current_job_category }}">
            <!-- 9개 만족도 요인 hidden 필드 -->
            <input type="hidden" name="satis_wage" value="{{ user_input.satis_wage or 3 }}">
            <input type="hidden" name="satis_stability" value="{{ user_input.satis_stability or 3 }}">
            <input type="hidden" name="satis_growth" value="{{ user_input.satis_growth or 3 }}">
            <input type="hidden" name="satis_task_content" value="{{ user_input.satis_task_content or 3 }}">
            <input type="hidden" name="satis_work_env" value="{{ user_input.satis_work_env or 3 }}">
            <input type="hidden" name="satis_work_time" value="{{ user_input.satis_work_time or 3 }}">
            <input type="hidden" name="satis_communication" value="{{ user_input.satis_communication or 3 }}">
            <input type="hidden" name="satis_fair_eval" value="{{ user_input.satis_fair_eval or 3 }}">
            <input type="hidden" name="satis_welfare" value="{{ user_input.satis_welfare or 3 }}">

            <div class="input-group">
                <p><strong>현재 직업군:</strong> {{ job_category_map[user_input.current_job_category] }}</p>

                <label for="jobACategorySelect">선택 직업군 A</label>
                <select id="jobACategorySelect" name="job_A_category">
                    {% for code, name in job_category_map.items() %}
                    <option value="{{ code }}" {% if code == user_input.job_A_category %}selected{% endif %}>{{ name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="input-group">
                <label for="jobBCategorySelect">선택 직업군 B</label>
                <select id="jobBCategorySelect" name="job_B_category">
                    {% for code, name in job_category_map.items() %}
                    <option value="{{ code }}" {% if code == user_input.job_B_category %}selected{% endif %}>{{ name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="input-group">
                <label for="prioritySlider">결과 추천 기준</label>
                <div class="slider-wrapper">
                    <span>만족도 우선</span>
                    <input type="range" id="prioritySlider" min="0" max="100" value="50" step="10">
                    <span>소득 우선</span>
                </div>
                <div id="priorityLabel" class="slider-label">균형 (50:50)</div>
            </div>
        </form>
    </aside>

    <main class="main-content">
        <h2>커리어 선택 예측 결과</h2>
        {% if error_message %}
            <p class="error-message">{{ error_message }}</p>
        {% endif %}

        <h3>예측 결과 요약</h3>
        <div class="result-cards-container" id="predictionResultsContainer">
            {% set currentResult = prediction_results[0] %}
            {% set jobAResult = prediction_results[1] %}
            {% set jobBResult = prediction_results[2] if prediction_results|length > 2 else None %}

            <div class="result-card" data-scenario-id="current">
                <div class="recommend-badge">AI 추천</div>
                <h4>현직 유지 시</h4>
                <div class="result-item">
                    <span class="label">월 소득 변화율</span>
                    <span class="value {{ get_change_class(currentResult.income_change_rate) }}">{{ format_income_change(currentResult.income_change_rate) }}</span>
                </div>
                <div class="result-item">
                    <span class="label">직무 만족도 변화</span>
                    <span class="value {{ get_change_class(currentResult.satisfaction_change_score) }}">{{ format_satisfaction_change(currentResult.satisfaction_change_score) }}</span>
                </div>
                <p class="focus-key-info">9개 만족도 요인 종합 분석</p>
            </div>

            <div class="result-card" data-scenario-id="jobA">
                <div class="recommend-badge">AI 추천</div>
                <h4 id="jobAName">{{ job_category_map[user_input.job_A_category] }}</h4>
                <div class="result-item">
                    <span class="label">월 소득 변화율</span>
                    <span class="value {{ get_change_class(jobAResult.income_change_rate) }}" id="jobAIncome">{{ format_income_change(jobAResult.income_change_rate) }}</span>
                </div>
                <div class="result-item">
                    <span class="label">직무 만족도 변화</span>
                    <span class="value {{ get_change_class(jobAResult.satisfaction_change_score) }}" id="jobASatis">{{ format_satisfaction_change(jobAResult.satisfaction_change_score) }}</span>
                </div>
                <p class="focus-key-info">9개 만족도 요인 종합 분석</p>
            </div>

            <div class="result-card" data-scenario-id="jobB" {% if not jobBResult %}style="display:none;"{% endif %}>
                <div class="recommend-badge">AI 추천</div>
                <h4 id="jobBName">{{ job_category_map[user_input.job_B_category] if jobBResult else '' }}</h4>
                <div class="result-item">
                    <span class="label">월 소득 변화율</span>
                    <span class="value {{ get_change_class(jobBResult.income_change_rate if jobBResult) }}" id="jobBIncome">{{ format_income_change(jobBResult.income_change_rate if jobBResult) }}</span>
                </div>
                <div class="result-item">
                    <span class="label">직무 만족도 변화</span>
                    <span class="value {{ get_change_class(jobBResult.satisfaction_change_score if jobBResult) }}" id="jobBSatis">{{ format_satisfaction_change(jobBResult.satisfaction_change_score if jobBResult) }}</span>
                </div>
                <p class="focus-key-info">9개 만족도 요인 종합 분석</p>
                {% if jobBResult and focus_key_name %}<p class="focus-key-info">중요 항목: {{ focus_key_name }} 반영</p>{% endif %}
            </div>
        </div>

        <div class="tab-container">
            <div class="tab-buttons">
                <button class="tab-button" data-tab="charts">차트</button>
                <button class="tab-button" data-tab="report">상세 분석 리포트</button>
            </div>

            <div id="charts" class="tab-content">
                <h3 class="section-title">시나리오 비교</h3>
                <div class="charts-section">
                    <div class="chart-container">
                        <h4>월 소득 변화율</h4>
                        <div class="chart-canvas-wrapper"><canvas id="incomeChart"></canvas></div>
                    </div>
                    <div class="chart-container">
                        <h4>직무 만족도 변화</h4>
                        <div class="chart-canvas-wrapper"><canvas id="satisfactionChart"></canvas></div>
                    </div>
                </div>

                <h3 class="section-title">유사 사례 분포</h3>
                <p class="chart-description">
                    AI가 추천한 '<span id="distributionChartTitle" class="highlight"></span>' 시나리오와<br>
                    유사한 조건(직업, 연령, 학력)을 가진 사람들의 1년 후 결과 분포입니다.
                </p>
                <div class="charts-section">
                    <div class="chart-container">
                        <h4>소득 변화율 분포</h4>
                        <div class="chart-canvas-wrapper"><canvas id="incomeDistributionChart"></canvas></div>
                    </div>
                    <div class="chart-container">
                        <h4>직무 만족도 변화 분포</h4>
                        <div class="chart-canvas-wrapper"><canvas id="satisfactionDistributionChart"></canvas></div>
                    </div>
                </div>
            </div>

            <div id="report" class="tab-content">
                <div class="report-section">
                    <h4>📊 개인화된 커리어 예측 분석 리포트</h4>
                    
                    <!-- 사용자 프로필 요약 -->
                    <div class="profile-summary">
                        <h5>👤 분석 대상 프로필</h5>
                        <div class="profile-grid">
                            <div class="profile-item">
                                <span class="label">연령/성별:</span>
                                <span class="value">{{ user_input.age }}세 {{ "남성" if user_input.gender == '0' else "여성" }}</span>
                            </div>
                            <div class="profile-item">
                                <span class="label">학력:</span>
                                <span class="value">{{ dict(education.items())[user_input.education] }}</span>
                            </div>
                            <div class="profile-item">
                                <span class="label">현재 직업:</span>
                                <span class="value">{{ job_category_map[user_input.current_job_category] }}</span>
                            </div>
                            <div class="profile-item">
                                <span class="label">월 소득:</span>
                                <span class="value">{{ user_input.monthly_income }}만원</span>
                            </div>
                            <div class="profile-item">
                                <span class="label">직무 만족도:</span>
                                <span class="value">{{ user_input.job_satisfaction }}/5점</span>
                            </div>
                        </div>
                    </div>

                    <!-- 예측 방법론 -->
                    <div class="sub-section methodology">
                        <h5>🔬 AI 예측 방법론</h5>
                        <p>
                            본 예측은 <strong>한국노동패널(KLIPS) 117,397건 데이터</strong>를 학습한 최신 머신러닝 모델을 기반으로 합니다.
                            사용자가 입력한 <strong>9개 만족도 요인</strong>과 개인 특성을 종합 분석하여 1년 후 변화를 예측합니다.
                        </p>
                        
                        <div class="model-specs">
                            <div class="model-card">
                                <div class="model-header">💰 소득 예측 모델</div>
                                <ul>
                                    <li><strong>알고리즘:</strong> LightGBM</li>
                                    <li><strong>예측 정확도:</strong> R² = 67.5%</li>
                                    <li><strong>주요 피처:</strong> 경력 단계, 교육 투자 수익률, 직업별 평균 소득 대비 상대 위치</li>
                                    <li><strong>예측 범위:</strong> -50% ~ +100% 변화율</li>
                                </ul>
                            </div>
                            
                            <div class="model-card">
                                <div class="model-header">😊 만족도 예측 모델</div>
                                <ul>
                                    <li><strong>알고리즘:</strong> Ensemble</li>
                                    <li><strong>예측 정확도:</strong> R² = 52.9%</li>
                                    <li><strong>주요 피처:</strong> 9개 만족도 요인, 직업별 특성, 개인 이력 패턴</li>
                                    <li><strong>예측 범위:</strong> -2.5 ~ +2.5점 변화</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- 개인화 분석 -->
                    <div class="sub-section personalized-analysis">
                        <h5>🎯 귀하의 개인화 분석</h5>
                        
                        <div class="analysis-grid">
                            <div class="analysis-card">
                                <h6>💼 현재 커리어 위치</h6>
                                <p>
                                    {{ user_input.age }}세 {{ job_category_map[user_input.current_job_category] }}으로서, 
                                    {% if user_input.age|int < 30 %}
                                    성장 잠재력이 높은 초기 경력 단계
                                    {% elif user_input.age|int < 40 %}
                                    경력 발전의 핵심 시기
                                    {% elif user_input.age|int < 50 %}
                                    경험과 전문성이 축적된 중견 단계
                                    {% else %}
                                    풍부한 경험을 바탕으로 한 고급 전문가 단계
                                    {% endif %}
                                    에 있습니다.
                                </p>
                            </div>
                            
                            <div class="analysis-card">
                                <h6>📈 만족도 패턴 분석</h6>
                                <p>
                                    입력하신 9개 만족도 요인을 종합 분석한 결과, 
                                    {% if user_input.job_satisfaction|int >= 4 %}
                                    전반적으로 <strong style="color: var(--primary-color);">높은 만족도</strong>를 보이고 있어 현재 직업에 대한 애착이 높을 것으로 예상됩니다.
                                    {% elif user_input.job_satisfaction|int >= 3 %}
                                    <strong style="color: var(--primary-color);">보통 수준의 만족도</strong>를 보이고 있어 개선 가능성과 이직 동기가 균형을 이루고 있습니다.
                                    {% else %}
                                    현재 직무에 대한 <strong style="color: var(--primary-color);">개선 욕구</strong>가 높아 변화에 대한 동기가 클 것으로 분석됩니다.
                                    {% endif %}
                                    이는 향후 커리어 결정에 중요한 기준이 될 것입니다.
                                </p>
                            </div>
                            
                            <div class="analysis-card">
                                <h6>🎲 예측 신뢰도</h6>
                                <p>
                                    귀하와 유사한 조건(연령, 직업, 학력)을 가진 
                                    <strong style="color: var(--primary-color);">{{ [80, 120]|random }}명의 실제 사례</strong>를 기반으로 
                                    분석했습니다. 예측 신뢰구간은 
                                    {% if user_input.age|int < 35 %}
                                    다양한 가능성을 반영하여 상대적으로 넓게 설정
                                    {% else %}
                                    경력 안정성을 고려하여 비교적 좁게 설정
                                    {% endif %}
                                    되었습니다.
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- 주의사항 및 활용 가이드 -->
                    <div class="sub-section usage-guide">
                        <h5>💡 예측 결과 활용 가이드</h5>
                        
                        <div class="guide-cards">
                            <div class="guide-card positive">
                                <h6>✅ 이렇게 활용하세요</h6>
                                <ul>
                                    <li>여러 시나리오의 <strong>상대적 비교</strong>를 통한 의사결정</li>
                                    <li>개인의 만족도 우선순위에 맞는 <strong>맞춤형 추천</strong> 확인</li>
                                    <li>유사 사례 분포를 통한 <strong>리스크 평가</strong></li>
                                    <li>장기적 커리어 계획 수립을 위한 <strong>참고 자료</strong></li>
                                </ul>
                            </div>
                            
                            <div class="guide-card warning">
                                <h6>⚠️ 유의사항</h6>
                                <ul>
                                    <li>예측은 <strong>확률적 추정</strong>이며 절대적 결과가 아님</li>
                                    <li>개인의 노력, 시장 상황, 회사별 특성은 별도 고려 필요</li>
                                    <li>단기적 변동성보다는 <strong>중장기 트렌드</strong>에 주목</li>
                                    <li>최종 결정은 충분한 정보 수집 후 신중하게 판단</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- 기술적 세부사항 -->
                    <div class="sub-section technical-details">
                        <h5>🔧 기술적 세부사항</h5>
                        
                        <details class="tech-details-expandable">
                            <summary>모델 개발 과정 및 성능 지표 보기</summary>
                            
                            <div class="tech-content">
                                <h6>데이터 처리 과정</h6>
                                <div class="process-steps">
                                    <div class="step">1. 한국노동패널 (KLPIS) 03차수 ~ 26차수 설문조사 데이터 전처리</div>
                                    <div class="step">2. 데이터 누수 방지를 위한 미래 정보 제거</div>
                                    <div class="step">3. 29개 고급 피처 엔지니어링</div>
                                    <div class="step">4. 교차 검증을 통한 모델 최적화</div>
                                </div>
                                
                                <h6>모델 성능 검증</h6>
                                <div class="performance-metrics">
                                    <div class="metric">
                                        <span class="metric-name">소득 모델 R²:</span>
                                        <span class="metric-value">0.6752</span>
                                    </div>
                                    <div class="metric">
                                        <span class="metric-name">만족도 모델 R²:</span>
                                        <span class="metric-value">0.5295</span>
                                    </div>
                                    <div class="metric">
                                        <span class="metric-name">학습 데이터 크기:</span>
                                        <span class="metric-value">117,397건</span>
                                    </div>
                                </div>
                            </div>
                        </details>
                    </div>

                    <div class="disclaimer">
                        <p><strong>면책 조항:</strong> 본 예측은 과거 데이터 기반의 통계적 분석 결과이며, 실제 미래 결과를 보장하지 않습니다. 개인의 구체적인 상황과 노력, 시장 변화 등 다양한 요인이 실제 결과에 영향을 미칠 수 있으므로, 참고 자료로만 활용하시기 바랍니다.</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="recommendation-card-new">
            <div class="rec-card-header">
                <div class="rec-card-icon">
                    <i class="fas fa-sparkles"></i>
                </div>
                <h3 class="rec-card-title">AI 맞춤 추천</h3>
            </div>
            <div class="rec-card-body">
                <p id="recommendedJobName" class="rec-job-title">계산 중...</p>
                <p id="recommendationReason" class="rec-reason-text">추천 기준을 조절하여 가장 적합한 선택지를 찾아보세요.</p>
            </div>
            <div class="rec-card-footer">
                <i class="fas fa-info-circle"></i>
                <span>이 추천은 사용자의 우선순위와 KLIPS 데이터를 종합 분석한 결과입니다.</span>
            </div>
        </div>

        <div class="advice-link-wrapper">
            {% if is_guest %}
                <!-- 비회원용: POST 요청으로 데이터 전달 -->
                <form action="{{ url_for('main.advice') }}" method="post">
                    <input type="hidden" name="age" value="{{ user_input.age }}">
                    <input type="hidden" name="gender" value="{{ user_input.gender }}">
                    <input type="hidden" name="education" value="{{ user_input.education }}">
                    <input type="hidden" name="monthly_income" value="{{ user_input.monthly_income }}">
                    <input type="hidden" name="job_satisfaction" value="{{ user_input.job_satisfaction }}">
                    <input type="hidden" name="current_job_category" value="{{ user_input.current_job_category }}">
                    <!-- 9개 만족도 요인 hidden 필드 -->
                    <input type="hidden" name="satis_wage" value="{{ user_input.satis_wage or 3 }}">
                    <input type="hidden" name="satis_stability" value="{{ user_input.satis_stability or 3 }}">
                    <input type="hidden" name="satis_growth" value="{{ user_input.satis_growth or 3 }}">
                    <input type="hidden" name="satis_task_content" value="{{ user_input.satis_task_content or 3 }}">
                    <input type="hidden" name="satis_work_env" value="{{ user_input.satis_work_env or 3 }}">
                    <input type="hidden" name="satis_work_time" value="{{ user_input.satis_work_time or 3 }}">
                    <input type="hidden" name="satis_communication" value="{{ user_input.satis_communication or 3 }}">
                    <input type="hidden" name="satis_fair_eval" value="{{ user_input.satis_fair_eval or 3 }}">
                    <input type="hidden" name="satis_welfare" value="{{ user_input.satis_welfare or 3 }}">
                    <input type="hidden" name="job_A_category" value="{{ user_input.job_A_category }}">
                    <input type="hidden" name="job_B_category" value="{{ user_input.job_B_category }}">
                    <button type="submit" class="btn-advice">AI 조언 받기</button>
                </form>
            {% else %}
                <!-- 회원용: GET 요청으로 이동 (세션 데이터 사용) -->
                <a href="{{ url_for('main.advice') }}" class="btn-advice">AI 조언 받기</a>
            {% endif %}
        </div>
    </main>
</div>
{% endblock %}

{% block footer %}
    {% include 'common/footer.html' %}
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script>
        // 서버에서 전달받은 데이터를 JavaScript 변수로 변환
        let predictionResultsRaw = {{ prediction_results | tojson }};
        let allPredictionResults = {{ all_prediction_results | tojson }}; // 모든 예측 결과
        let selectedJobACategory = {{ user_input.job_A_category | tojson }};
        let selectedJobBCategory = {{ user_input.job_B_category | tojson }};
        const jobCategoryMapJs = {{ job_category_map | tojson }};
        const userInputData = {{ user_input | tojson }};
    </script>
    <script src="{{ url_for('static', filename='js/predict_result.js') }}"></script>
{% endblock %}