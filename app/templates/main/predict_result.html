{% extends 'base.html' %}

{% block title %}예측 결과 | NEXTEP.AI{% endblock %}

{% block head %}
    {{ super() }}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/header.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/footer.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/predict_result.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
{% endblock %}

{% block header %}
    {% include 'common/header.html' %}
{% endblock %}

{% block content %}
<div class="page-wrapper">
    <aside class="sidebar">
        <h3>직업군 선택</h3>
        <form id="predictionForm" action="{{ url_for('main.predict_result') }}" method="post">
            {# 페이지에서 직접 변경되지 않는 원본 사용자 정보만 hidden으로 유지 #}
            <input type="hidden" name="age" value="{{ user_input.age }}">
            <input type="hidden" name="gender" value="{{ user_input.gender }}">
            <input type="hidden" name="education" value="{{ user_input.education }}">
            <input type="hidden" name="monthly_income" value="{{ user_input.monthly_income }}">
            <input type="hidden" name="job_satisfaction" value="{{ user_input.job_satisfaction }}">
            <input type="hidden" name="current_job_category" value="{{ user_input.current_job_category }}">
            <!-- 9개 만족도 요인 hidden 필드 -->
            <input type="hidden" name="satis_wage" value="{{ user_input.satis_wage or 3 }}">
            <input type="hidden" name="satis_stability" value="{{ user_input.satis_stability or 3 }}">
            <input type="hidden" name="satis_growth" value="{{ user_input.satis_growth or 3 }}">
            <input type="hidden" name="satis_task_content" value="{{ user_input.satis_task_content or 3 }}">
            <input type="hidden" name="satis_work_env" value="{{ user_input.satis_work_env or 3 }}">
            <input type="hidden" name="satis_work_time" value="{{ user_input.satis_work_time or 3 }}">
            <input type="hidden" name="satis_communication" value="{{ user_input.satis_communication or 3 }}">
            <input type="hidden" name="satis_fair_eval" value="{{ user_input.satis_fair_eval or 3 }}">
            <input type="hidden" name="satis_welfare" value="{{ user_input.satis_welfare or 3 }}">

            <div class="input-group">
                <p><strong>현재 직업군:</strong> {{ job_category_map[user_input.current_job_category] }}</p>

                <label for="jobACategorySelect">선택 직업군 A</label>
                <select id="jobACategorySelect" name="job_A_category" onchange="this.form.submit()">
                    {% for code, name in job_category_map.items() %}
                    <option value="{{ code }}" {% if code == user_input.job_A_category %}selected{% endif %}>{{ name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="input-group">
                <label for="jobBCategorySelect">선택 직업군 B</label>
                <select id="jobBCategorySelect" name="job_B_category" onchange="this.form.submit()">
                    {% for code, name in job_category_map.items() %}
                    <option value="{{ code }}" {% if code == user_input.job_B_category %}selected{% endif %}>{{ name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="input-group">
                <label for="prioritySlider">결과 추천 기준</label>
                <div class="slider-wrapper">
                    <span>만족도 우선</span>
                    <input type="range" id="prioritySlider" min="0" max="100" value="50" step="10">
                    <span>소득 우선</span>
                </div>
                <div id="priorityLabel" class="slider-label">균형 (50:50)</div>
            </div>
        </form>
    </aside>

    <main class="main-content">
        <h2>커리어 선택 예측 결과</h2>
        {% if error_message %}
            <p class="error-message">{{ error_message }}</p>
        {% endif %}

        <h3>예측 결과 요약</h3>
        <div class="result-cards-container" id="predictionResultsContainer">
            {% set currentResult = prediction_results[0] %}
            {% set jobAResult = prediction_results[1] %}
            {% set jobBResult = prediction_results[2] if prediction_results|length > 2 else None %}

            <div class="result-card" data-scenario-id="current">
                <div class="recommend-badge">AI 추천</div>
                <h4>현직 유지 시</h4>
                <div class="result-item">
                    <span class="label">월 소득 변화율</span>
                    <span class="value {{ get_change_class(currentResult.income_change_rate) }}">{{ format_income_change(currentResult.income_change_rate) }}</span>
                </div>
                <div class="result-item">
                    <span class="label">직무 만족도 변화</span>
                    <span class="value {{ get_change_class(currentResult.satisfaction_change_score) }}">{{ format_satisfaction_change(currentResult.satisfaction_change_score) }}</span>
                </div>
                <p class="focus-key-info">9개 만족도 요인 종합 분석</p>
            </div>

            <div class="result-card" data-scenario-id="jobA">
                <div class="recommend-badge">AI 추천</div>
                <h4 id="jobAName">{{ job_category_map[user_input.job_A_category] }}</h4>
                <div class="result-item">
                    <span class="label">월 소득 변화율</span>
                    <span class="value {{ get_change_class(jobAResult.income_change_rate) }}" id="jobAIncome">{{ format_income_change(jobAResult.income_change_rate) }}</span>
                </div>
                <div class="result-item">
                    <span class="label">직무 만족도 변화</span>
                    <span class="value {{ get_change_class(jobAResult.satisfaction_change_score) }}" id="jobASatis">{{ format_satisfaction_change(jobAResult.satisfaction_change_score) }}</span>
                </div>
                <p class="focus-key-info">9개 만족도 요인 종합 분석</p>
            </div>

            <div class="result-card" data-scenario-id="jobB" {% if not jobBResult %}style="display:none;"{% endif %}>
                <div class="recommend-badge">AI 추천</div>
                <h4 id="jobBName">{{ job_category_map[user_input.job_B_category] if jobBResult else '' }}</h4>
                <div class="result-item">
                    <span class="label">월 소득 변화율</span>
                    <span class="value {{ get_change_class(jobBResult.income_change_rate if jobBResult) }}" id="jobBIncome">{{ format_income_change(jobBResult.income_change_rate if jobBResult) }}</span>
                </div>
                <div class="result-item">
                    <span class="label">직무 만족도 변화</span>
                    <span class="value {{ get_change_class(jobBResult.satisfaction_change_score if jobBResult) }}" id="jobBSatis">{{ format_satisfaction_change(jobBResult.satisfaction_change_score if jobBResult) }}</span>
                </div>
                <p class="focus-key-info">9개 만족도 요인 종합 분석</p>
                {% if jobBResult and focus_key_name %}<p class="focus-key-info">중요 항목: {{ focus_key_name }} 반영</p>{% endif %}
            </div>
        </div>

        <div class="tab-container">
            <div class="tab-buttons">
                <button class="tab-button" data-tab="charts">차트</button>
                <button class="tab-button" data-tab="report">상세 분석 리포트</button>
            </div>

            <div id="charts" class="tab-content">
                <h3 class="section-title">시나리오 비교</h3>
                <div class="charts-section">
                    <div class="chart-container">
                        <h4>월 소득 변화율</h4>
                        <div class="chart-canvas-wrapper"><canvas id="incomeChart"></canvas></div>
                    </div>
                    <div class="chart-container">
                        <h4>직무 만족도 변화</h4>
                        <div class="chart-canvas-wrapper"><canvas id="satisfactionChart"></canvas></div>
                    </div>
                </div>

                <h3 class="section-title">유사 사례 분포</h3>
                <p class="chart-description">
                    AI가 추천한 '<span id="distributionChartTitle" class="highlight"></span>' 시나리오와<br>
                    유사한 조건(직업, 연령, 학력)을 가진 사람들의 1년 후 결과 분포입니다.
                </p>
                <div class="charts-section">
                    <div class="chart-container">
                        <h4>소득 변화율 분포</h4>
                        <div class="chart-canvas-wrapper"><canvas id="incomeDistributionChart"></canvas></div>
                    </div>
                    <div class="chart-container">
                        <h4>직무 만족도 변화 분포</h4>
                        <div class="chart-canvas-wrapper"><canvas id="satisfactionDistributionChart"></canvas></div>
                    </div>
                </div>
            </div>

            <div id="report" class="tab-content">
                <div class="report-section">
                    <h4>AI 예측 모델 상세 리포트</h4>
                    <p>
                        본 리포트는 <strong>{{ user_input.age }}세, {{ "남성" if user_input.gender == '0' else "여성" }}, {{ dict(education.items())[user_input.education] }}</strong>인 사용자의 데이터를 기반으로,
                        NEXTEP.AI의 예측 모델이 분석한 커리어 경로별 예상 변화입니다.
                        현재 직업인 <strong>{{ job_category_map[user_input.current_job_category] }}</strong>(월 소득 {{ user_input.monthly_income }}만원)을 유지하는 시나리오와
                        새로운 직업으로 이직하는 시나리오를 비교 분석합니다.
                    </p>

                    <div class="sub-section">
                        <h5>예측 결과, 어떻게 해석해야 할까요?</h5>
                        <p>
                            예측 결과는 향후 1년간의 <strong>월 소득 변화율(%)</strong>과 <strong>직무 만족도 변화(점)</strong>를 중심으로 제공됩니다.
                            특히, 이직 시나리오의 소득은 해당 직업군의 평균 소득을 기준으로 예측되었으며, 만족도는 사용자가 입력한
                            <strong class="highlight">9개 만족도 요인별 점수</strong>를 종합적으로 분석하여 변화를 예측했습니다.
                        </p>
                        <ul>
                            <li>
                                <strong>소득 변화율</strong>: 현재 소득 대비 1년 후의 소득 변화 비율입니다. 이직 시에는 해당 직업군의 평균 소득으로 이동하는 것을 가정합니다.
                            </li>
                            <li>
                                <strong>만족도 변화</strong>: 현재 만족도 점수 대비 1년 후의 만족도 변화량입니다. 긍정적(+) 또는 부정적(-) 변화를 나타냅니다.
                            </li>
                        </ul>
                        <p>
                            AI 추천은 사용자가 설정한 <strong>'소득'과 '만족도'의 우선순위</strong>에 따라 가장 높은 점수를 받은 시나리오를 동적으로 제시합니다.
                            슬라이더를 조절하여 자신에게 맞는 최적의 경로를 탐색해 보세요.
                        </p>
                    </div>

                    <div class="sub-section">
                        <h5>NEXTEP.AI의 예측 모델은 어떻게 만들어졌나요?</h5>
                        <p>
                            본 예측에는 한국노동패널(KLIPS) 데이터를 학습한 최신 머신러닝 모델이 사용되었습니다. 
                            두 가지 핵심 모델이 협력하여 정확한 예측을 제공합니다.
                        </p>
                        <ul>
                            <li>
                                <strong>소득 예측 모델:</strong> LightGBM 알고리즘으로 R² 75.8% 달성. 
                                29개의 고급 시계열 피처를 통해 개인의 소득 변화 패턴을 예측합니다.
                            </li>
                            <li>
                                <strong>만족도 예측 모델:</strong> XGBoost + CatBoost 앙상블 모델로 R² 64% 수준. 
                                9개 만족도 요인의 복합적 상호작용을 분석하여 직무 만족도 변화를 예측합니다.
                            </li>
                        </ul>
                        
                        <h5>개발 과정에서 마주한 주요 도전과 해결책</h5>
                        <p>
                            높은 정확도의 모델을 구축하기 위해 여러 단계의 문제를 해결해야 했습니다.
                        </p>
                        
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0;">
                            <h6 style="color: #e74c3c; margin: 0 0 10px 0;">🚨 문제 1: 데이터 누수 발견</h6>
                            <p style="margin: 0;">초기 모델이 95%라는 비현실적 성능을 보여 조사한 결과, 미래 정보가 포함된 피처들을 발견했습니다. 
                            윤리적 AI 구현을 위해 이러한 피처들을 모두 제거했습니다.</p>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0;">
                            <h6 style="color: #f39c12; margin: 0 0 10px 0;">📉 문제 2: 성능 급락</h6>
                            <p style="margin: 0;">데이터 정화 후 성능이 1% 수준으로 급락했습니다. 
                            이를 해결하기 위해 개인별 이력 패턴, 경력 단계, 동료 대비 상대적 위치 등 
                            18개의 새로운 고급 피처를 개발했습니다.</p>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0;">
                            <h6 style="color: #27ae60; margin: 0 0 10px 0;">🎯 해결책: 알고리즘 최적화</h6>
                            <p style="margin: 0;">여러 알고리즘을 비교 테스트한 결과, 
                            소득 모델은 LightGBM에서 최고 성능(76%)을 달성했고, 
                            만족도 모델은 여러 알고리즘의 앙상블로 안정성을 확보했습니다.</p>
                        </div>

                        <h5>최종 달성한 성과</h5>
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 12px; margin: 20px 0; text-align: center;">
                            <h6 style="color: white; margin: 0 0 15px 0; font-size: 18px;">🎯 핵심 성과 지표</h6>
                            <div style="display: flex; justify-content: space-around; flex-wrap: wrap;">
                                <div style="text-align: center; margin: 10px;">
                                    <div style="font-size: 24px; font-weight: bold;">75.8%</div>
                                    <div style="font-size: 14px; opacity: 0.9;">소득 예측 정확도</div>
                                </div>
                                <div style="text-align: center; margin: 10px;">
                                    <div style="font-size: 24px; font-weight: bold;">64%</div>
                                    <div style="font-size: 14px; opacity: 0.9;">만족도 예측 정확도</div>
                                </div>
                                <div style="text-align: center; margin: 10px;">
                                    <div style="font-size: 24px; font-weight: bold;">3600%</div>
                                    <div style="font-size: 14px; opacity: 0.9;">성능 향상률</div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0;">
                            <h6 style="color: #2c3e50; margin-top: 0;">🔧 핵심 기술 요소</h6>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; font-size: 14px;">
                                <div>• LightGBM 최적화 알고리즘</div>
                                <div>• 29개 고급 시계열 피처</div>
                                <div>• 3중 앙상블 시스템</div>
                                <div>• 데이터 누수 완전 차단</div>
                                <div>• 실시간 피처 생성</div>
                                <div>• 다중 백업 시스템</div>
                            </div>
                        </div>
                    </div>
                     <p style="text-align: right; font-size: 0.85rem; color: #888; margin-top: 20px;">
                        - 본 리포트는 통계적 예측이며, 실제 결과와는 차이가 있을 수 있습니다. -
                    </p>
                </div>
            </div>
        </div>

        <div class="recommendation-card">
            <h3 class="section-title">AI 추천</h3>
            <div class="recommendation-section">
                <div class="recommendation-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.898 20.562L16.25 21.75l-.648-1.188a2.25 2.25 0 01-1.423-1.423L13.5 18.75l1.188-.648a2.25 2.25 0 011.423 1.423l.648 1.188z" />
                    </svg>
                </div>
                <div class="recommendation-content">
                    <p class="recommendation-label">AI 추천 선택지</p>
                    <p id="recommendedJobName" class="recommendation-title">계산 중...</p>
                    <p id="recommendationReason" class="recommendation-reason">추천 기준을 조절하여 가장 적합한 선택지를 찾아보세요.</p>
                </div>
            </div>
        </div>

        <div class="advice-link-wrapper">
            {% if is_guest %}
                <!-- 비회원용: POST 요청으로 데이터 전달 -->
                <form action="{{ url_for('main.advice') }}" method="post">
                    <input type="hidden" name="age" value="{{ user_input.age }}">
                    <input type="hidden" name="gender" value="{{ user_input.gender }}">
                    <input type="hidden" name="education" value="{{ user_input.education }}">
                    <input type="hidden" name="monthly_income" value="{{ user_input.monthly_income }}">
                    <input type="hidden" name="job_satisfaction" value="{{ user_input.job_satisfaction }}">
                    <input type="hidden" name="current_job_category" value="{{ user_input.current_job_category }}">
                    <!-- 9개 만족도 요인 hidden 필드 -->
                    <input type="hidden" name="satis_wage" value="{{ user_input.satis_wage or 3 }}">
                    <input type="hidden" name="satis_stability" value="{{ user_input.satis_stability or 3 }}">
                    <input type="hidden" name="satis_growth" value="{{ user_input.satis_growth or 3 }}">
                    <input type="hidden" name="satis_task_content" value="{{ user_input.satis_task_content or 3 }}">
                    <input type="hidden" name="satis_work_env" value="{{ user_input.satis_work_env or 3 }}">
                    <input type="hidden" name="satis_work_time" value="{{ user_input.satis_work_time or 3 }}">
                    <input type="hidden" name="satis_communication" value="{{ user_input.satis_communication or 3 }}">
                    <input type="hidden" name="satis_fair_eval" value="{{ user_input.satis_fair_eval or 3 }}">
                    <input type="hidden" name="satis_welfare" value="{{ user_input.satis_welfare or 3 }}">
                    <input type="hidden" name="job_A_category" value="{{ user_input.job_A_category }}">
                    <input type="hidden" name="job_B_category" value="{{ user_input.job_B_category }}">
                    <button type="submit" class="btn-advice">AI 조언 받기</button>
                </form>
            {% else %}
                <!-- 회원용: GET 요청으로 이동 (세션 데이터 사용) -->
                <a href="{{ url_for('main.advice') }}" class="btn-advice">✨ AI 조언 받기</a>
            {% endif %}
        </div>
    </main>
</div>
{% endblock %}

{% block footer %}
    {% include 'common/footer.html' %}
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script>
        // 서버에서 전달받은 데이터를 JavaScript 변수로 변환
        const predictionResultsRaw = {{ prediction_results | tojson }};
        const selectedJobACategory = {{ user_input.job_A_category | tojson }};
        const selectedJobBCategory = {{ user_input.job_B_category | tojson }};
        const jobCategoryMapJs = {{ job_category_map | tojson }};
    </script>
    <script src="{{ url_for('static', filename='js/predict_result.js') }}"></script>
{% endblock %}