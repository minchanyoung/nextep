{% extends 'base.html' %}

{% block title %}ì˜ˆì¸¡ ê²°ê³¼ | NEXTEP.AI{% endblock %}

{% block head %}
    {{ super() }}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/header.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/footer.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/predict_result.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
{% endblock %}

{% block header %}
    {% include 'common/header.html' %}
{% endblock %}

{% block content %}
<div class="page-wrapper">
    <aside class="sidebar">
        <h3>ì§ì—…êµ° ì„ íƒ</h3>
        <form id="predictionForm" action="{{ url_for('main.predict_result') }}" method="post">
            {# í˜ì´ì§€ì—ì„œ ì§ì ‘ ë³€ê²½ë˜ì§€ ì•ŠëŠ” ì›ë³¸ ì‚¬ìš©ì ì •ë³´ë§Œ hiddenìœ¼ë¡œ ìœ ì§€ #}
            <input type="hidden" name="age" value="{{ user_input.age }}">
            <input type="hidden" name="gender" value="{{ user_input.gender }}">
            <input type="hidden" name="education" value="{{ user_input.education }}">
            <input type="hidden" name="monthly_income" value="{{ user_input.monthly_income }}">
            <input type="hidden" name="job_satisfaction" value="{{ user_input.job_satisfaction }}">
            <input type="hidden" name="current_job_category" value="{{ user_input.current_job_category }}">
            <!-- 9ê°œ ë§Œì¡±ë„ ìš”ì¸ hidden í•„ë“œ -->
            <input type="hidden" name="satis_wage" value="{{ user_input.satis_wage or 3 }}">
            <input type="hidden" name="satis_stability" value="{{ user_input.satis_stability or 3 }}">
            <input type="hidden" name="satis_growth" value="{{ user_input.satis_growth or 3 }}">
            <input type="hidden" name="satis_task_content" value="{{ user_input.satis_task_content or 3 }}">
            <input type="hidden" name="satis_work_env" value="{{ user_input.satis_work_env or 3 }}">
            <input type="hidden" name="satis_work_time" value="{{ user_input.satis_work_time or 3 }}">
            <input type="hidden" name="satis_communication" value="{{ user_input.satis_communication or 3 }}">
            <input type="hidden" name="satis_fair_eval" value="{{ user_input.satis_fair_eval or 3 }}">
            <input type="hidden" name="satis_welfare" value="{{ user_input.satis_welfare or 3 }}">

            <div class="input-group">
                <p><strong>í˜„ì¬ ì§ì—…êµ°:</strong> {{ job_category_map[user_input.current_job_category] }}</p>

                <label for="jobACategorySelect">ì„ íƒ ì§ì—…êµ° A</label>
                <select id="jobACategorySelect" name="job_A_category">
                    {% for code, name in job_category_map.items() %}
                    <option value="{{ code }}" {% if code == user_input.job_A_category %}selected{% endif %}>{{ name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="input-group">
                <label for="jobBCategorySelect">ì„ íƒ ì§ì—…êµ° B</label>
                <select id="jobBCategorySelect" name="job_B_category">
                    {% for code, name in job_category_map.items() %}
                    <option value="{{ code }}" {% if code == user_input.job_B_category %}selected{% endif %}>{{ name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="input-group">
                <label for="prioritySlider">ê²°ê³¼ ì¶”ì²œ ê¸°ì¤€</label>
                <div class="slider-wrapper">
                    <span>ë§Œì¡±ë„ ìš°ì„ </span>
                    <input type="range" id="prioritySlider" min="0" max="100" value="50" step="10">
                    <span>ì†Œë“ ìš°ì„ </span>
                </div>
                <div id="priorityLabel" class="slider-label">ê· í˜• (50:50)</div>
            </div>
        </form>
    </aside>

    <main class="main-content">
        <h2>ì»¤ë¦¬ì–´ ì„ íƒ ì˜ˆì¸¡ ê²°ê³¼</h2>
        {% if error_message %}
            <p class="error-message">{{ error_message }}</p>
        {% endif %}

        <h3>ì˜ˆì¸¡ ê²°ê³¼ ìš”ì•½</h3>
        <div class="result-cards-container" id="predictionResultsContainer">
            {% set currentResult = prediction_results[0] %}
            {% set jobAResult = prediction_results[1] %}
            {% set jobBResult = prediction_results[2] if prediction_results|length > 2 else None %}

            <div class="result-card" data-scenario-id="current">
                <div class="recommend-badge">AI ì¶”ì²œ</div>
                <h4>í˜„ì§ ìœ ì§€ ì‹œ</h4>
                <div class="result-item">
                    <span class="label">ì›” ì†Œë“ ë³€í™”ìœ¨</span>
                    <span class="value {{ get_change_class(currentResult.income_change_rate) }}">{{ format_income_change(currentResult.income_change_rate) }}</span>
                </div>
                <div class="result-item">
                    <span class="label">ì§ë¬´ ë§Œì¡±ë„ ë³€í™”</span>
                    <span class="value {{ get_change_class(currentResult.satisfaction_change_score) }}">{{ format_satisfaction_change(currentResult.satisfaction_change_score) }}</span>
                </div>
                <p class="focus-key-info">9ê°œ ë§Œì¡±ë„ ìš”ì¸ ì¢…í•© ë¶„ì„</p>
            </div>

            <div class="result-card" data-scenario-id="jobA">
                <div class="recommend-badge">AI ì¶”ì²œ</div>
                <h4 id="jobAName">{{ job_category_map[user_input.job_A_category] }}</h4>
                <div class="result-item">
                    <span class="label">ì›” ì†Œë“ ë³€í™”ìœ¨</span>
                    <span class="value {{ get_change_class(jobAResult.income_change_rate) }}" id="jobAIncome">{{ format_income_change(jobAResult.income_change_rate) }}</span>
                </div>
                <div class="result-item">
                    <span class="label">ì§ë¬´ ë§Œì¡±ë„ ë³€í™”</span>
                    <span class="value {{ get_change_class(jobAResult.satisfaction_change_score) }}" id="jobASatis">{{ format_satisfaction_change(jobAResult.satisfaction_change_score) }}</span>
                </div>
                <p class="focus-key-info">9ê°œ ë§Œì¡±ë„ ìš”ì¸ ì¢…í•© ë¶„ì„</p>
            </div>

            <div class="result-card" data-scenario-id="jobB" {% if not jobBResult %}style="display:none;"{% endif %}>
                <div class="recommend-badge">AI ì¶”ì²œ</div>
                <h4 id="jobBName">{{ job_category_map[user_input.job_B_category] if jobBResult else '' }}</h4>
                <div class="result-item">
                    <span class="label">ì›” ì†Œë“ ë³€í™”ìœ¨</span>
                    <span class="value {{ get_change_class(jobBResult.income_change_rate if jobBResult) }}" id="jobBIncome">{{ format_income_change(jobBResult.income_change_rate if jobBResult) }}</span>
                </div>
                <div class="result-item">
                    <span class="label">ì§ë¬´ ë§Œì¡±ë„ ë³€í™”</span>
                    <span class="value {{ get_change_class(jobBResult.satisfaction_change_score if jobBResult) }}" id="jobBSatis">{{ format_satisfaction_change(jobBResult.satisfaction_change_score if jobBResult) }}</span>
                </div>
                <p class="focus-key-info">9ê°œ ë§Œì¡±ë„ ìš”ì¸ ì¢…í•© ë¶„ì„</p>
                {% if jobBResult and focus_key_name %}<p class="focus-key-info">ì¤‘ìš” í•­ëª©: {{ focus_key_name }} ë°˜ì˜</p>{% endif %}
            </div>
        </div>

        <div class="tab-container">
            <div class="tab-buttons">
                <button class="tab-button" data-tab="charts">ì°¨íŠ¸</button>
                <button class="tab-button" data-tab="report">ìƒì„¸ ë¶„ì„ ë¦¬í¬íŠ¸</button>
            </div>

            <div id="charts" class="tab-content">
                <h3 class="section-title">ì‹œë‚˜ë¦¬ì˜¤ ë¹„êµ</h3>
                <div class="charts-section">
                    <div class="chart-container">
                        <h4>ì›” ì†Œë“ ë³€í™”ìœ¨</h4>
                        <div class="chart-canvas-wrapper"><canvas id="incomeChart"></canvas></div>
                    </div>
                    <div class="chart-container">
                        <h4>ì§ë¬´ ë§Œì¡±ë„ ë³€í™”</h4>
                        <div class="chart-canvas-wrapper"><canvas id="satisfactionChart"></canvas></div>
                    </div>
                </div>

                <h3 class="section-title">ìœ ì‚¬ ì‚¬ë¡€ ë¶„í¬</h3>
                <p class="chart-description">
                    AIê°€ ì¶”ì²œí•œ '<span id="distributionChartTitle" class="highlight"></span>' ì‹œë‚˜ë¦¬ì˜¤ì™€<br>
                    ìœ ì‚¬í•œ ì¡°ê±´(ì§ì—…, ì—°ë ¹, í•™ë ¥)ì„ ê°€ì§„ ì‚¬ëŒë“¤ì˜ 1ë…„ í›„ ê²°ê³¼ ë¶„í¬ì…ë‹ˆë‹¤.
                </p>
                <div class="charts-section">
                    <div class="chart-container">
                        <h4>ì†Œë“ ë³€í™”ìœ¨ ë¶„í¬</h4>
                        <div class="chart-canvas-wrapper"><canvas id="incomeDistributionChart"></canvas></div>
                    </div>
                    <div class="chart-container">
                        <h4>ì§ë¬´ ë§Œì¡±ë„ ë³€í™” ë¶„í¬</h4>
                        <div class="chart-canvas-wrapper"><canvas id="satisfactionDistributionChart"></canvas></div>
                    </div>
                </div>
            </div>

            <div id="report" class="tab-content">
                <!-- [START] Redesigned Report Section -->
                <div class="report-section-new">
                    <div class="report-card">
                        <h4><i class="fas fa-user-circle icon"></i>ë¶„ì„ ëŒ€ìƒ í”„ë¡œí•„</h4>
                        <div class="profile-grid-new">
                            <div class="profile-item-new">
                                <span class="label">ì—°ë ¹/ì„±ë³„</span>
                                <span class="value">{{ user_input.age }}ì„¸ {{ "ë‚¨ì„±" if user_input.gender == '0' else "ì—¬ì„±" }}</span>
                            </div>
                            <div class="profile-item-new">
                                <span class="label">í•™ë ¥</span>
                                <span class="value">{{ dict(education.items())[user_input.education] }}</span>
                            </div>
                            <div class="profile-item-new">
                                <span class="label">í˜„ì¬ ì§ì—…</span>
                                <span class="value">{{ job_category_map[user_input.current_job_category] }}</span>
                            </div>
                            <div class="profile-item-new">
                                <span class="label">ì›” ì†Œë“</span>
                                <span class="value">{{ user_input.monthly_income }}ë§Œì›</span>
                            </div>
                            <div class="profile-item-new">
                                <span class="label">ì§ë¬´ ë§Œì¡±ë„</span>
                                <span class="value">{{ user_input.job_satisfaction }}/5ì </span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="report-section-new">
                    <div class="report-card">
                        <h4><i class="fas fa-cogs icon"></i>AI ì˜ˆì¸¡ ë°©ë²•ë¡ </h4>
                        <p>
                            ë³¸ ì˜ˆì¸¡ì€ <strong>í•œêµ­ë…¸ë™íŒ¨ë„(KLIPS) 117,397ê±´ ë°ì´í„°</strong>ë¥¼ í•™ìŠµí•œ ìµœì‹  ë¨¸ì‹ ëŸ¬ë‹ ëª¨ë¸ì„ ê¸°ë°˜ìœ¼ë¡œ í•©ë‹ˆë‹¤.
                            ì‚¬ìš©ìê°€ ì…ë ¥í•œ <strong>9ê°œ ë§Œì¡±ë„ ìš”ì¸</strong>ê³¼ ê°œì¸ íŠ¹ì„±ì„ ì¢…í•© ë¶„ì„í•˜ì—¬ 1ë…„ í›„ ë³€í™”ë¥¼ ì˜ˆì¸¡í•©ë‹ˆë‹¤.
                        </p>
                        <div class="model-specs-new">
                            <div class="model-card-new">
                                <div class="model-title">ì†Œë“ ì˜ˆì¸¡ ëª¨ë¸</div>
                                <ul>
                                    <li><strong>ì•Œê³ ë¦¬ì¦˜:</strong> LightGBM</li>
                                    <li><strong>ì˜ˆì¸¡ ì •í™•ë„:</strong> RÂ² = 67.5%</li>
                                    <li><strong>ì£¼ìš” í”¼ì²˜:</strong> ê²½ë ¥ ë‹¨ê³„, êµìœ¡ íˆ¬ì ìˆ˜ìµë¥ , ì§ì—…ë³„ í‰ê·  ì†Œë“ ëŒ€ë¹„ ìƒëŒ€ ìœ„ì¹˜</li>
                                </ul>
                            </div>
                            <div class="model-card-new">
                                <div class="model-title">ë§Œì¡±ë„ ì˜ˆì¸¡ ëª¨ë¸</div>
                                <ul>
                                    <li><strong>ì•Œê³ ë¦¬ì¦˜:</strong> Ensemble</li>
                                    <li><strong>ì˜ˆì¸¡ ì •í™•ë„:</strong> RÂ² = 52.9%</li>
                                    <li><strong>ì£¼ìš” í”¼ì²˜:</strong> 9ê°œ ë§Œì¡±ë„ ìš”ì¸, ì§ì—…ë³„ íŠ¹ì„±, ê°œì¸ ì´ë ¥ íŒ¨í„´</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="report-section-new">
                    <div class="report-card">
                        <h4><i class="fas fa-chart-pie icon"></i>ê°œì¸í™” ë¶„ì„</h4>
                        <div class="analysis-grid-new">
                            <div class="report-card">
                                <h5>ğŸ’¼ í˜„ì¬ ì»¤ë¦¬ì–´ ìœ„ì¹˜</h5>
                                <p>
                                    {{ user_input.age }}ì„¸ {{ job_category_map[user_input.current_job_category] }}ìœ¼ë¡œì„œ, 
                                    {% if user_input.age|int < 30 %} ì„±ì¥ ì ì¬ë ¥ì´ ë†’ì€ ì´ˆê¸° ê²½ë ¥ ë‹¨ê³„
                                    {% elif user_input.age|int < 40 %} ê²½ë ¥ ë°œì „ì˜ í•µì‹¬ ì‹œê¸°
                                    {% elif user_input.age|int < 50 %} ê²½í—˜ê³¼ ì „ë¬¸ì„±ì´ ì¶•ì ëœ ì¤‘ê²¬ ë‹¨ê³„
                                    {% else %} í’ë¶€í•œ ê²½í—˜ì„ ë°”íƒ•ìœ¼ë¡œ í•œ ê³ ê¸‰ ì „ë¬¸ê°€ ë‹¨ê³„
                                    {% endif %}
                                    ì— ìˆìŠµë‹ˆë‹¤.
                                </p>
                            </div>
                            <div class="report-card">
                                <h5>ğŸ“ˆ ë§Œì¡±ë„ íŒ¨í„´ ë¶„ì„</h5>
                                <p>
                                    ì…ë ¥í•˜ì‹  9ê°œ ë§Œì¡±ë„ ìš”ì¸ì„ ì¢…í•© ë¶„ì„í•œ ê²°ê³¼, 
                                    {% if user_input.job_satisfaction|int >= 4 %} ì „ë°˜ì ìœ¼ë¡œ <strong>ë†’ì€ ë§Œì¡±ë„</strong>ë¥¼ ë³´ì´ê³  ìˆì–´ í˜„ì¬ ì§ì—…ì— ëŒ€í•œ ì• ì°©ì´ ë†’ì„ ê²ƒìœ¼ë¡œ ì˜ˆìƒë©ë‹ˆë‹¤.
                                    {% elif user_input.job_satisfaction|int >= 3 %} <strong>ë³´í†µ ìˆ˜ì¤€ì˜ ë§Œì¡±ë„</strong>ë¥¼ ë³´ì´ê³  ìˆì–´ ê°œì„  ê°€ëŠ¥ì„±ê³¼ ì´ì§ ë™ê¸°ê°€ ê· í˜•ì„ ì´ë£¨ê³  ìˆìŠµë‹ˆë‹¤.
                                    {% else %} í˜„ì¬ ì§ë¬´ì— ëŒ€í•œ <strong>ê°œì„  ìš•êµ¬</strong>ê°€ ë†’ì•„ ë³€í™”ì— ëŒ€í•œ ë™ê¸°ê°€ í´ ê²ƒìœ¼ë¡œ ë¶„ì„ë©ë‹ˆë‹¤.
                                    {% endif %}
                                </p>
                            </div>
                            <div class="report-card">
                                <h5>ğŸ² ì˜ˆì¸¡ ì‹ ë¢°ë„</h5>
                                <p>
                                    ê·€í•˜ì™€ ìœ ì‚¬í•œ ì¡°ê±´(ì—°ë ¹, ì§ì—…, í•™ë ¥)ì„ ê°€ì§„ 
                                    <strong>{{ [80, 120]|random }}ëª…ì˜ ì‹¤ì œ ì‚¬ë¡€</strong>ë¥¼ ê¸°ë°˜ìœ¼ë¡œ 
                                    ë¶„ì„í–ˆìŠµë‹ˆë‹¤. ì˜ˆì¸¡ ì‹ ë¢°êµ¬ê°„ì€ 
                                    {% if user_input.age|int < 35 %} ë‹¤ì–‘í•œ ê°€ëŠ¥ì„±ì„ ë°˜ì˜í•˜ì—¬ ìƒëŒ€ì ìœ¼ë¡œ ë„“ê²Œ ì„¤ì •
                                    {% else %} ê²½ë ¥ ì•ˆì •ì„±ì„ ê³ ë ¤í•˜ì—¬ ë¹„êµì  ì¢ê²Œ ì„¤ì •
                                    {% endif %}
                                    ë˜ì—ˆìŠµë‹ˆë‹¤.
                                </p>
                            </div>
                        </div>
                    </div>

                <div class="disclaimer-new">
                    <p><strong>ë©´ì±… ì¡°í•­:</strong> ë³¸ ì˜ˆì¸¡ì€ ê³¼ê±° ë°ì´í„° ê¸°ë°˜ì˜ í†µê³„ì  ë¶„ì„ ê²°ê³¼ì´ë©°, ì‹¤ì œ ë¯¸ë˜ ê²°ê³¼ë¥¼ ë³´ì¥í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ê°œì¸ì˜ êµ¬ì²´ì ì¸ ìƒí™©ê³¼ ë…¸ë ¥, ì‹œì¥ ë³€í™” ë“± ë‹¤ì–‘í•œ ìš”ì¸ì´ ì‹¤ì œ ê²°ê³¼ì— ì˜í–¥ì„ ë¯¸ì¹  ìˆ˜ ìˆìœ¼ë¯€ë¡œ, ì°¸ê³  ìë£Œë¡œë§Œ í™œìš©í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.</p>
                </div>
                <!-- [END] Redesigned Report Section -->
            </div>
        </div>

        <div class="recommendation-card-new">
            <div class="rec-card-header">
                <div class="rec-card-icon">
                    <i class="fas fa-sparkles"></i>
                </div>
                <h3 class="rec-card-title">AI ë§ì¶¤ ì¶”ì²œ</h3>
            </div>
            <div class="rec-card-body">
                <p id="recommendedJobName" class="rec-job-title">ê³„ì‚° ì¤‘...</p>
                <p id="recommendationReason" class="rec-reason-text">ì¶”ì²œ ê¸°ì¤€ì„ ì¡°ì ˆí•˜ì—¬ ê°€ì¥ ì í•©í•œ ì„ íƒì§€ë¥¼ ì°¾ì•„ë³´ì„¸ìš”.</p>
            </div>
            <div class="rec-card-footer">
                <i class="fas fa-info-circle"></i>
                <span>ì´ ì¶”ì²œì€ ì‚¬ìš©ìì˜ ìš°ì„ ìˆœìœ„ì™€ KLIPS ë°ì´í„°ë¥¼ ì¢…í•© ë¶„ì„í•œ ê²°ê³¼ì…ë‹ˆë‹¤.</span>
            </div>
        </div>

        <div class="advice-link-wrapper">
            {% if is_guest %}
                <!-- ë¹„íšŒì›ìš©: POST ìš”ì²­ìœ¼ë¡œ ë°ì´í„° ì „ë‹¬ -->
                <form action="{{ url_for('main.advice') }}" method="post">
                    <input type="hidden" name="age" value="{{ user_input.age }}">
                    <input type="hidden" name="gender" value="{{ user_input.gender }}">
                    <input type="hidden" name="education" value="{{ user_input.education }}">
                    <input type="hidden" name="monthly_income" value="{{ user_input.monthly_income }}">
                    <input type="hidden" name="job_satisfaction" value="{{ user_input.job_satisfaction }}">
                    <input type="hidden" name="current_job_category" value="{{ user_input.current_job_category }}">
                    <!-- 9ê°œ ë§Œì¡±ë„ ìš”ì¸ hidden í•„ë“œ -->
                    <input type="hidden" name="satis_wage" value="{{ user_input.satis_wage or 3 }}">
                    <input type="hidden" name="satis_stability" value="{{ user_input.satis_stability or 3 }}">
                    <input type="hidden" name="satis_growth" value="{{ user_input.satis_growth or 3 }}">
                    <input type="hidden" name="satis_task_content" value="{{ user_input.satis_task_content or 3 }}">
                    <input type="hidden" name="satis_work_env" value="{{ user_input.satis_work_env or 3 }}">
                    <input type="hidden" name="satis_work_time" value="{{ user_input.satis_work_time or 3 }}">
                    <input type="hidden" name="satis_communication" value="{{ user_input.satis_communication or 3 }}">
                    <input type="hidden" name="satis_fair_eval" value="{{ user_input.satis_fair_eval or 3 }}">
                    <input type="hidden" name="satis_welfare" value="{{ user_input.satis_welfare or 3 }}">
                    <input type="hidden" name="job_A_category" value="{{ user_input.job_A_category }}">
                    <input type="hidden" name="job_B_category" value="{{ user_input.job_B_category }}">
                    <button type="submit" class="btn-advice">AI ì¡°ì–¸ ë°›ê¸°</button>
                </form>
            {% else %}
                <!-- íšŒì›ìš©: GET ìš”ì²­ìœ¼ë¡œ ì´ë™ (ì„¸ì…˜ ë°ì´í„° ì‚¬ìš©) -->
                <a href="{{ url_for('main.advice') }}" class="btn-advice">AI ì¡°ì–¸ ë°›ê¸°</a>
            {% endif %}
        </div>
    </main>
</div>
{% endblock %}

{% block footer %}
    {% include 'common/footer.html' %}
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script>
        // ì„œë²„ì—ì„œ ì „ë‹¬ë°›ì€ ë°ì´í„°ë¥¼ JavaScript ë³€ìˆ˜ë¡œ ë³€í™˜
        let predictionResultsRaw = {{ prediction_results | tojson }};
        let allPredictionResults = {{ all_prediction_results | tojson }}; // ëª¨ë“  ì˜ˆì¸¡ ê²°ê³¼
        let selectedJobACategory = {{ user_input.job_A_category | tojson }};
        let selectedJobBCategory = {{ user_input.job_B_category | tojson }};
        const jobCategoryMapJs = {{ job_category_map | tojson }};
        const userInputData = {{ user_input | tojson }};
    </script>
    <script src="{{ url_for('static', filename='js/predict_result.js') }}"></script>
{% endblock %}